---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import { BOOKS } from "@consts";
import Link from "@components/Link.astro";

const books = (await getCollection("books"))
  .filter(book => !book.data.draft)
  .sort((a, b) => {
    // 1. Sort by year descending (e.g. 2024 before 2023)
    if (a.data.year !== b.data.year) {
      return b.data.year - a.data.year;
    }
    
    // 2. Prioritize "reading" status within the same year
    if (a.data.status === "reading" && b.data.status !== "reading") {
      return -1;
    }
    if (a.data.status !== "reading" && b.data.status === "reading") {
      return 1;
    }

    // 3. Finally sort by dateRead descending if available
    if (a.data.dateRead && b.data.dateRead) {
      return b.data.dateRead.valueOf() - a.data.dateRead.valueOf();
    }
    return 0;
  });

// Group books by year
const booksByYear = books.reduce((acc, book) => {
  const year = book.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(book);
  return acc;
}, {} as Record<number, typeof books>);

const years = Object.keys(booksByYear).map(Number).sort((a, b) => b - a);

const getStatusEmoji = (status: string) => {
  switch (status) {
    case "completed": return "âœ“";
    case "reading": return "ðŸ“–";
    case "to-read": return "ðŸ“š";
    default: return "";
  }
};

const getRatingStars = (rating?: number) => {
  if (!rating) return "";
  return "â˜…".repeat(rating) + "â˜†".repeat(5 - rating);
};
---

<PageLayout title={BOOKS.TITLE} description={BOOKS.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate font-semibold text-black dark:text-white">
        Book Notes
      </div>
      <div class="animate space-y-8">
        {years.map((year) => (
          <div class="space-y-4">
            <div class="font-semibold text-black dark:text-white">
              {year}
            </div>
            <ul class="flex flex-col gap-4">
              {booksByYear[year].map((book) => (
                <li>
                  <Link href={`/books/${book.slug}`} underline={false}>
                    <div class="group relative flex flex-col gap-1 p-4 border border-black/15 dark:border-white/20 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors duration-300 ease-in-out w-full font-sans">
                      <div class="flex items-center gap-2">
                        <span class="text-xs px-1.5 py-0.5 bg-black/5 dark:bg-white/10 rounded">
                          {getStatusEmoji(book.data.status)}
                        </span>
                        <div class="font-semibold text-black dark:text-white transition-colors duration-300">
                          {book.data.title}
                        </div>
                      </div>
                      <div class="text-sm text-black/60 dark:text-white/60 line-clamp-1">
                        {book.data.author} {book.data.description && <span> â€” {book.data.description}</span>}
                      </div>
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 24 24"
                        class="absolute top-1/2 right-4 -translate-y-1/2 size-5 stroke-2 fill-none stroke-current opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out">
                        <line x1="5" y1="12" x2="19" y2="12" class="translate-x-3 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out" />
                        <polyline points="12 5 19 12 12 19" class="-translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out" />
                      </svg>
                    </div>
                  </Link>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </Container>
</PageLayout>
